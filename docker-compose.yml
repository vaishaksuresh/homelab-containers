version: '3.8'

services:

# macvlan shim setup - must run first
  macvlan-shim:
    image: alpine:latest
    container_name: macvlan-shim
    network_mode: host
    privileged: true
    restart: unless-stopped
    command: >
      sh -c "
      ip link delete macvlan-shim 2>/dev/null || true &&
      ip link add macvlan-shim link eth0 type macvlan mode bridge &&
      ip addr add 10.0.20.199/32 dev macvlan-shim &&
      ip link set macvlan-shim up &&
      sysctl -w net.ipv4.conf.all.proxy_arp=1 &&
      sysctl -w net.ipv4.conf.eth0.proxy_arp=1 &&
      sysctl -w net.ipv4.conf.macvlan-shim.proxy_arp=1 &&
      sysctl -w net.ipv4.conf.all.forwarding=1 &&
      ip route add 10.0.20.16/28 dev macvlan-shim 2>/dev/null || true &&
      ip route add 10.0.20.48/28 dev macvlan-shim 2>/dev/null || true &&
      ip route add 10.0.20.64/26 dev macvlan-shim 2>/dev/null || true &&
      ip route add 10.0.20.144/28 dev macvlan-shim 2>/dev/null || true &&
      ip route add 10.0.20.192/28 dev macvlan-shim 2>/dev/null || true &&
      ip route add 10.0.20.240/28 dev macvlan-shim 2>/dev/null || true &&
      echo 'macvlan shim created' &&
      tail -f /dev/null
      "
  adguard:
    image: adguard/adguardhome:latest
    container_name: adguardhome
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - NET_BIND_SERVICE
    volumes:
      - ./adguardhome/workdir:/opt/adguardhome/work
      - ./adguardhome/confdir:/opt/adguardhome/conf
    networks:
      macvlan_services:
        ipv4_address: 10.0.20.30

  pihole:
    image: pihole/pihole:latest
    container_name: pihole-docker
    restart: unless-stopped
    environment:
      TZ: 'America/Los_Angeles'
      WEBPASSWORD: 'changeme'
    volumes:
      - ./pihole/etc-pihole:/etc/pihole
    networks:
      macvlan_services:
        ipv4_address: 10.0.20.31

  nginx-proxy:
    image: jc21/nginx-proxy-manager:latest
    container_name: nginx-proxy-manager
    restart: unless-stopped
    volumes:
      - ./nginx-proxy-manager/data:/data
      - ./nginx-proxy-manager/letsencrypt:/etc/letsencrypt
    dns:              # ADD THIS
      - 10.0.20.30
      - 1.1.1.1
    networks:
      macvlan_services:
        ipv4_address: 10.0.20.200

  # syncthing:
  #   image: linuxserver/syncthing:latest
  #   container_name: Syncthing
  #   restart: unless-stopped
  #   environment:
  #     - PUID=1000
  #     - PGID=1000
  #     - TZ=America/Los_Angeles
  #   volumes:
  #     - ./syncthing/config:/config
  #     - /share/CACHEDEV1_DATA/Syncthing:/data
  #   networks:
  #     macvlan_services:
  #       ipv4_address: 10.0.20.50

  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    restart: unless-stopped
    environment:
      # Discord notifications
      - WATCHTOWER_NOTIFICATIONS=shoutrrr
      - WATCHTOWER_NOTIFICATION_URL=<endpoint>
      - WATCHTOWER_NOTIFICATIONS_LEVEL=info
      - WATCHTOWER_NOTIFICATION_TITLE= Watchtower Homelab Updates - Kryptonite

      # Update settings
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_INCLUDE_RESTARTING=true
      - WATCHTOWER_INCLUDE_STOPPED=false
      - WATCHTOWER_SCHEDULE=0 0 4 * * *  # 4 AM daily
      - TZ=America/Los_Angeles
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      macvlan_services:
        ipv4_address: 10.0.20.254

  home-assistant:
    image: ghcr.io/home-assistant/home-assistant:stable
    container_name: home-assistant
    restart: unless-stopped
    privileged: true
    volumes:
      - ./home-assistant/config:/config
      - /etc/localtime:/etc/localtime:ro
    networks:
      macvlan_services:
        ipv4_address: 10.0.20.123

  homebridge:
    image: homebridge/homebridge:latest
    container_name: homebridge
    restart: unless-stopped
    volumes:
      - ./homebridge:/homebridge
    networks:
      macvlan_services:
        ipv4_address: 10.0.20.124
  # ============================================
  # REMOTE ACCESS
  # ============================================
  rustdesk-hbbs:
    image: rustdesk/rustdesk-server:latest
    container_name: rustdesk-hbbs
    restart: unless-stopped
    command: hbbs -r 10.0.20.151:21117
    volumes:
      - ./rustdesk/hbbs:/root
    networks:
      macvlan_services:
        ipv4_address: 10.0.20.150

  rustdesk-hbbr:
    image: rustdesk/rustdesk-server:latest
    container_name: rustdesk-hbbr
    restart: unless-stopped
    command: hbbr
    volumes:
      - ./rustdesk/hbbr:/root
    networks:
      macvlan_services:
        ipv4_address: 10.0.20.151
  # ============================================
  # MONITORING & DASHBOARDS
  # ============================================
  homarr:
    image: ghcr.io/ajnart/homarr:latest
    container_name: homarr
    restart: unless-stopped
    environment:
      - TZ=America/Los_Angeles
    volumes:
      - ./homarr/configs:/app/data/configs
      - ./homarr/icons:/app/public/icons
      - ./homarr/data:/data
    networks:
      macvlan_services:
        ipv4_address: 10.0.20.60

  uptime-kuma:
    image: louislam/uptime-kuma:latest
    container_name: uptime-kuma
    restart: unless-stopped
    volumes:
      - ./uptime-kuma:/app/data
    dns:              # ADD THIS
      - 10.0.20.30
      - 1.1.1.1
    networks:
      macvlan_services:
        ipv4_address: 10.0.20.61

  # ============================================
  # PHOTO MANAGEMENT - IMMICH
  # ============================================
  immich-server:
    image: ghcr.io/immich-app/immich-server:release
    container_name: immich-server
    restart: unless-stopped
    volumes:
      - ./immich/upload:/usr/src/app/upload
      - /share/CACHEDEV1_DATA/Multimedia/Pictures:/mnt/media/pictures:ro
      - /etc/localtime:/etc/localtime:ro
    environment:
      - DB_HOSTNAME=immich-postgres
      - DB_USERNAME=postgres
      - DB_PASSWORD=postgres
      - DB_DATABASE_NAME=immich
      - REDIS_HOSTNAME=immich-redis
      - IMMICH_MACHINE_LEARNING_URL=http://immich-machine-learning:3003
    depends_on:
      - immich-redis
      - immich-postgres
    networks:
      macvlan_services:
        ipv4_address: 10.0.20.70

  immich-machine-learning:
    image: ghcr.io/immich-app/immich-machine-learning:release
    container_name: immich-machine-learning
    restart: unless-stopped
    volumes:
      - ./immich/model-cache:/cache
    networks:
      macvlan_services:
        ipv4_address: 10.0.20.71

  immich-redis:
    image: redis:7-alpine
    container_name: immich-redis
    restart: unless-stopped
    networks:
      macvlan_services:
        ipv4_address: 10.0.20.72

  immich-postgres:
    image: tensorchord/pgvecto-rs:pg14-v0.2.0
    container_name: immich-postgres
    restart: unless-stopped
    environment:
      POSTGRES_PASSWORD: postgres
      POSTGRES_USER: postgres
      POSTGRES_DB: immich
    volumes:
      - ./immich/postgres:/var/lib/postgresql/data
    networks:
      macvlan_services:
        ipv4_address: 10.0.20.73


networks:
  macvlan_services:
    driver: macvlan
    driver_opts:
      parent: eth0
    ipam:
      config:
        - subnet: 10.0.20.0/24
          gateway: 10.0.20.1
