version: '3.8'

# Reusable DNS configuration
x-dns: &default-dns
  - 10.0.20.30  # AdGuard
  - 1.1.1.1     # Cloudflare fallback

services:
  # ==========================================
  # INFRASTRUCTURE
  # ==========================================
  
  # macvlan shim - enables container <-> host communication
  macvlan-shim:
    image: alpine:latest
    container_name: macvlan-shim
    network_mode: host
    privileged: true
    restart: unless-stopped
    command: >
      sh -c "
      ip link delete macvlan-shim 2>/dev/null || true &&
      ip link add macvlan-shim link eth0 type macvlan mode bridge &&
      ip addr add 10.0.20.199/32 dev macvlan-shim &&
      ip link set macvlan-shim up &&
      sysctl -w net.ipv4.conf.all.proxy_arp=1 &&
      sysctl -w net.ipv4.conf.eth0.proxy_arp=1 &&
      sysctl -w net.ipv4.conf.macvlan-shim.proxy_arp=1 &&
      sysctl -w net.ipv4.conf.all.forwarding=1 &&
      ip route add 10.0.20.16/28 dev macvlan-shim 2>/dev/null || true &&
      ip route add 10.0.20.48/28 dev macvlan-shim 2>/dev/null || true &&
      ip route add 10.0.20.64/26 dev macvlan-shim 2>/dev/null || true &&
      ip route add 10.0.20.144/28 dev macvlan-shim 2>/dev/null || true &&
      ip route add 10.0.20.192/28 dev macvlan-shim 2>/dev/null || true &&
      ip route add 10.0.20.240/28 dev macvlan-shim 2>/dev/null || true &&
      echo 'macvlan shim created' &&
      tail -f /dev/null
      "

  # ==========================================
  # MONITORING & UPDATES
  # ==========================================

  # WUD - Container update monitoring with UI
  wud:
    image: getwud/wud:latest
    container_name: wud
    restart: unless-stopped
    dns: *default-dns
    depends_on:
      - macvlan-shim
    networks:
      macvlan_services:
        ipv4_address: 10.0.20.62
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./wud:/store
    environment:
      # Scan schedule (every 6 hours)
      - WUD_WATCHER_LOCAL_CRON=0 */6 * * *
      
      # Web UI Authentication (disabled - enable if exposing publicly)
      # - WUD_AUTH_BASIC_USER=${WUD_AUTH_USER}
      # - WUD_AUTH_BASIC_HASH=${WUD_AUTH_HASH}
      
      # Discord notifications (optional)
      - WUD_TRIGGER_DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL}
      - WUD_TRIGGER_DISCORD_WEBHOOK_MODE=simple
      - WUD_TRIGGER_DISCORD_WEBHOOK_ONCE=true
    labels:
      - wud.watch=false  # Don't monitor WUD itself

  # Watchtower - Auto-updater (can remove if using WUD exclusively)
  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    restart: unless-stopped
    dns: *default-dns
    depends_on:
      - macvlan-shim
    networks:
      macvlan_services:
        ipv4_address: 10.0.20.254
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - WATCHTOWER_NOTIFICATION_URL=${DISCORD_WEBHOOK_URL}
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_SCHEDULE=0 0 6 * * *
    labels:
      - wud.watch=false  # Don't monitor Watchtower

  # Uptime Kuma - Service monitoring
  uptime-kuma:
    image: louislam/uptime-kuma:1
    container_name: uptime-kuma
    restart: unless-stopped
    dns: *default-dns
    depends_on:
      - macvlan-shim
    networks:
      macvlan_services:
        ipv4_address: 10.0.20.61
    volumes:
      - ./uptime-kuma:/app/data
    labels:
      # WUD: Auto-update (stable service)
      - wud.watch=true
      - wud.tag.include=^\d+$  # Only major versions (1, 2, etc)

  # ==========================================
  # NETWORKING & DNS
  # ==========================================

  # AdGuard Home - Primary DNS with ad blocking
  adguardhome:
    image: adguard/adguardhome:latest
    container_name: adguardhome
    restart: unless-stopped
    depends_on:
      - macvlan-shim
    networks:
      macvlan_services:
        ipv4_address: 10.0.20.30
    volumes:
      - ./adguardhome/workdir:/opt/adguardhome/work
      - ./adguardhome/confdir:/opt/adguardhome/conf
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - NET_BIND_SERVICE
    labels:
      # WUD: Notify only (critical service)
      - wud.watch=true
      - wud.tag.include=^v\d+\.\d+\.\d+$

  # Pi-hole - Secondary DNS
  pihole-docker:
    image: pihole/pihole:latest
    container_name: pihole-docker
    restart: unless-stopped
    depends_on:
      - macvlan-shim
    networks:
      macvlan_services:
        ipv4_address: 10.0.20.31
    volumes:
      - ./pihole/etc-pihole:/etc/pihole
      - ./pihole/etc-dnsmasq.d:/etc/dnsmasq.d
    environment:
      - TZ=America/Los_Angeles
      - WEBPASSWORD=${PIHOLE_PASSWORD}
    cap_add:
      - NET_ADMIN
    labels:
      # WUD: Notify only
      - wud.watch=true

  # nginx Proxy Manager - Reverse proxy with SSL
  nginx-proxy-manager:
    image: jc21/nginx-proxy-manager:latest
    container_name: nginx-proxy-manager
    restart: unless-stopped
    dns: *default-dns
    depends_on:
      - macvlan-shim
    networks:
      macvlan_services:
        ipv4_address: 10.0.20.200
    volumes:
      - ./nginx-proxy-manager/data:/data
      - ./nginx-proxy-manager/letsencrypt:/etc/letsencrypt
    labels:
      # WUD: Auto-update (stable service)
      - wud.watch=true
      - wud.tag.include=^\d+\.\d+\.\d+$

  # ==========================================
  # HOME AUTOMATION
  # ==========================================

  # Home Assistant - Home automation platform
  home-assistant:
    image: ghcr.io/home-assistant/home-assistant:stable
    container_name: home-assistant
    restart: unless-stopped
    dns: *default-dns
    depends_on:
      - macvlan-shim
    networks:
      macvlan_services:
        ipv4_address: 10.0.20.123
    volumes:
      - ./home-assistant/config:/config
      - /etc/localtime:/etc/localtime:ro
    environment:
      - TZ=America/Los_Angeles
    privileged: true
    labels:
      # WUD: Notify only (critical service, manual updates)
      - wud.watch=true
      - wud.tag.include=^\d{4}\.\d{1,2}\.\d+$

  # Homebridge - HomeKit bridge
  homebridge:
    image: homebridge/homebridge:latest
    container_name: homebridge
    restart: unless-stopped
    dns: *default-dns
    depends_on:
      - macvlan-shim
    networks:
      macvlan_services:
        ipv4_address: 10.0.20.124
    volumes:
      - ./homebridge:/homebridge
    environment:
      - TZ=America/Los_Angeles
    labels:
      # WUD: Auto-update
      - wud.watch=true

  # ==========================================
  # DASHBOARDS
  # ==========================================

  # Homarr - Homelab dashboard
  homarr:
    image: ghcr.io/ajnart/homarr:latest
    container_name: homarr
    restart: unless-stopped
    dns: *default-dns
    depends_on:
      - macvlan-shim
    networks:
      macvlan_services:
        ipv4_address: 10.0.20.60
    volumes:
      - ./homarr/configs:/app/data/configs
      - ./homarr/icons:/app/public/icons
      - ./homarr/data:/data
    labels:
      # WUD: Auto-update
      - wud.watch=true

  # ==========================================
  # PHOTO MANAGEMENT
  # ==========================================

  # Immich - Photo management platform
  immich-server:
    image: ghcr.io/immich-app/immich-server:release
    container_name: immich-server
    restart: unless-stopped
    dns: *default-dns
    depends_on:
      - macvlan-shim
      - immich-redis
      - immich-postgres
    networks:
      macvlan_services:
        ipv4_address: 10.0.20.70
    volumes:
      - ./immich/upload:/usr/src/app/upload
      - /share/CACHEDEV1_DATA/Multimedia/Pictures:/usr/src/app/external:ro
    environment:
      - DB_HOSTNAME=immich-postgres
      - DB_USERNAME=postgres
      - DB_PASSWORD=${IMMICH_DB_PASSWORD}
      - DB_DATABASE_NAME=immich
      - REDIS_HOSTNAME=immich-redis
    labels:
      # WUD: Notify only (breaking changes possible)
      - wud.watch=true
      - wud.tag.include=^release$

  immich-machine-learning:
    image: ghcr.io/immich-app/immich-machine-learning:release
    container_name: immich-machine-learning
    restart: unless-stopped
    dns: *default-dns
    depends_on:
      - macvlan-shim
    networks:
      macvlan_services:
        ipv4_address: 10.0.20.71
    volumes:
      - ./immich/model-cache:/cache
    labels:
      - wud.watch=false  # Updated with immich-server

  immich-redis:
    image: redis:7-alpine
    container_name: immich-redis
    restart: unless-stopped
    dns: *default-dns
    depends_on:
      - macvlan-shim
    networks:
      macvlan_services:
        ipv4_address: 10.0.20.72
    labels:
      # WUD: Auto-update
      - wud.watch=true
      - wud.tag.include=^7-alpine$

  immich-postgres:
    image: tensorchord/pgvecto-rs:pg14-v0.2.0
    container_name: immich-postgres
    restart: unless-stopped
    dns: *default-dns
    depends_on:
      - macvlan-shim
    networks:
      macvlan_services:
        ipv4_address: 10.0.20.73
    volumes:
      - ./immich/postgres:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${IMMICH_DB_PASSWORD}
      - POSTGRES_DB=immich
    labels:
      # WUD: Don't auto-update databases
      - wud.watch=true
      - wud.tag.include=^pg14-v\d+\.\d+\.\d+$

  # ==========================================
  # REMOTE ACCESS
  # ==========================================

  # RustDesk - Remote desktop servers
  rustdesk-hbbs:
    image: rustdesk/rustdesk-server:latest
    container_name: rustdesk-hbbs
    restart: unless-stopped
    dns: *default-dns
    depends_on:
      - macvlan-shim
    networks:
      macvlan_services:
        ipv4_address: 10.0.20.150
    volumes:
      - ./rustdesk/hbbs:/root
    command: hbbs -r 10.0.20.151:21117
    labels:
      - wud.watch=true

  rustdesk-hbbr:
    image: rustdesk/rustdesk-server:latest
    container_name: rustdesk-hbbr
    restart: unless-stopped
    dns: *default-dns
    depends_on:
      - macvlan-shim
    networks:
      macvlan_services:
        ipv4_address: 10.0.20.151
    volumes:
      - ./rustdesk/hbbr:/root
    command: hbbr
    labels:
      - wud.watch=true

# ==========================================
# NETWORKS
# ==========================================

networks:
  macvlan_services:
    driver: macvlan
    driver_opts:
      parent: eth0
    ipam:
      config:
        - subnet: 10.0.20.0/24
          gateway: 10.0.20.1
